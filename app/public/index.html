<!DOCTYPE html>
<html>
    <head>
        <title>WUPHF.com</title>
        <meta charset="UTF-8">
        <meta name="description" content="WUPHF.com - The place to bark your thoughts">
        <meta name="keywords" content="wuphf, woof">
        <meta name="author" content="Mauro Farina">
        <meta name="viewport" content="width=device-width, initial-scale=1">

		<!-- Vue.js -->
		<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

		<!-- Bootstrap 5-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
        <!-- Bootstrap icons-->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
        <!-- Bootstrap JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>

        <link rel="stylesheet" href="./res/style.css">
    </head>
    
    <body data-bs-theme="dark">
        
        <main id="app" class="home-main text-bg-dark">

            <nav class="home-nav navbar navbar-expand-lg collapse-lg fixed-top">
                <div class="container-fluid">

                    <div class="container-fluid" id="buttonTogglerContainer">
                        <button class="navbar-toggler" type="button" data-state="closed" id="toggleNavbarButton" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                            <span class="navbar-toggler-icon"></span>
                        </button>
                    </div>

                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="nav-list me-auto mt-2 font-xl" style="flex-direction:column" v-cloak>
                            <li class="nav-item">
                                <span class="font-xxl" v-if="user.authenticated">Hi, <a @click.prevent="closeNavIfViewportWidthSmall(); goTo('/user/'.concat(user.username));" class="local-primary-text link-no-underline pointerOnHover">{{user.username}}</a></span>
                                <span v-if="!user.authenticated">
                                    <a href="/auth/" class="link-no-underline pointerOnHover">Signup</a> or <a href="/auth/login" class="link-no-underline pointerOnHover">Login</a>
                                </span>
                            </li>
                            <li v-if="user.authenticated" class="nav-item pointerOnHover">
                                <a @click.prevent="closeNavIfViewportWidthSmall(); goTo('/feed');">Feed</a>
                            </li>
                            <li v-if="user.authenticated" class="nav-item pointerOnHover">
                                <a @click.prevent="closeNavIfViewportWidthSmall(); backToTop();">New message</a>
                            </li>
                            <li v-if="user.authenticated" class="nav-item pointerOnHover">
                                <a @click.prevent="signOff">Sign off</a>
                            </li>
                            <div class="input-group nav-item">
                                <input id="searchUserInput" class="form-control" v-if="viewportWidth >= 975" v-model="usernameToLookup" @input.prevent="searchUser" placeholder="Search user" type="search" aria-label="Search">
                                <input id="searchUserInput" class="form-control" v-if="!(viewportWidth >= 975)" v-model="usernameToLookup" @keydown="searchByPressingEnter($event)" placeholder="Search user" type="search" aria-label="Search">
                                <button class="btn btn-success" @click.prevent="searchUser" type="submit" id="searchUserButton"><i class="bi bi-search" style="color: snow"></i></button>
                            </div>
                        </ul>
                    </div>

                </div>
            </nav>


            <section class="home-section text-start font-l">

                <div id="navLiveAlertPlaceholder" class="alert alert-warning alert-dismissible d-none" role="alert">
                    Something went wrong, try refreshing the page.
                    <button type="button" class="btn-close btn" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <div id="navLiveDangerAlertPlaceholder" class="alert alert-danger alert-dismissible d-none" role="alert">
                    Something went very wrong. Try refreshing the page.
                </div>

                <feed-container :user="user" :messages="messages" :current-path="currentPath"></feed-container>
                <!-- 
                    SHOUTOUT TO FARSAD FAKHIM https://stackoverflow.com/a/47559949
                    and a special thanks goes to console.log and border: 1px solid red for making this project possible https://www.reddit.com/1086q4s/
                -->

                <login-signup-message :user="user"></login-signup-message> 

                <search-users-container :user="user" :username-to-lookup="usernameToLookup" :search-user-results="searchUserResults" :current-path="currentPath"></search-users-container>

                <user-profile-container :user="user" :current-path="currentPath" :show-profile-of="showProfileOf"></user-profile-container>
            </section>

        </main>

        <script type="module">
            import {methodsFunctions, getUserData} from './vueAppFunctions.js';
            import {FeedContainer, MessageContainer, MessageBody, LoginSignupMessage, SearchUsersContainer, UserProfileContainer} from './VueComponents.js';

            const { createApp } = Vue;
            let userData;
            try {
                userData = await getUserData();
            } catch(err) {
                console.error(err);
                document.getElementById('navLiveDangerAlertPlaceholder').classList.remove('d-none');
            }
            /*
                Top level await is a feature available within modules. This means the await keyword can be used. 
                It allows modules to act as big asynchronous functions meaning code can be evaluated before use in parent modules, 
                but without blocking sibling modules from loading.
                https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules#top_level_await
            */

            const data = { 
                messages : userData.feed,
                user : userData.user,
                usernameToLookup : "",
                searchUserResults : [],
                currentPath : window.location.hash,
                showProfileOf : "",
                viewportWidth : window.visualViewport.width
            };

            const app = createApp({
                data() {
                    return data;
                },
                methods: {
                    backToTop : methodsFunctions.backToTop,
                    searchUser : methodsFunctions.searchUser,
                    goTo : methodsFunctions.goTo,
                    updateUserData: async function() {
                        let newUserData = await getUserData();
                        this.messages = newUserData.feed;
                        this.user = newUserData.user;
                    },
                    signOff: async function() {
                        try{ 
                            let signoffreq = await fetch('/api/auth/signoff');
                            if(signoffreq.ok) {
                                window.location.href = "/auth/login";
                            } else {
                                methodsFunctions.somethingWentWrongAlert();
                            }
                        } catch(err) {
                            methodsFunctions.somethingWentWrongAlert();
                        }
                    },
                    closeNavIfViewportWidthSmall : methodsFunctions.closeNavIfViewportWidthSmall,
                    searchByPressingEnter : function(e) {
                        if(e.key === 'Enter') {
                            this.searchUser();
                        }
                    }
                },
                watch: {
                    currentPath(newValue, oldValue) {
                        if(newValue === '#/feed' || newValue === '#/' || newValue === '#' || newValue === '') {
                            this.updateUserData(); // updates the feed when coming from another page (user/..., search?q=...)
                        }
                        if(!newValue.includes('user/') && oldValue.includes('user/')) {
                            this.showProfileOf = ""; // this way if one goes back to the same profile, infos will be updated (likes in particular)
                        }
                    }
                },
                mounted() {
                    window.addEventListener('hashchange', () => {
                        this.currentPath = window.location.hash; 
                        if(this.currentPath.includes('user/')) {
                            this.showProfileOf = this.currentPath.split('/')[2];
                        }
                        if(this.currentPath.includes('search?q=')) {
                            this.usernameToLookup = this.currentPath.split('search?q=')[1];
                            this.searchUser();
                        }
                    });
                    window.addEventListener('resize', () => {
                        this.viewportWidth = window.visualViewport.width;
                    });
                    if(this.currentPath.includes('user/')) {
                        this.showProfileOf = this.currentPath.split('/')[2];
                    }
                    if(this.currentPath.includes('search?q=')) {
                        this.usernameToLookup = this.currentPath.split('search?q=')[1];
                        this.searchUser();
                    }
                }
            });

            app.component("FeedContainer", FeedContainer);
            app.component("MessageContainer", MessageContainer);
            app.component("MessageBody", MessageBody);
            app.component("LoginSignupMessage", LoginSignupMessage);
            app.component("SearchUsersContainer", SearchUsersContainer);
            app.component("UserProfileContainer", UserProfileContainer);

            app.mount("#app");
        </script>

    </body>

</html>