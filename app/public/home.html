<!DOCTYPE html>
<html>
    <head>
        <title>WUPHF.com</title>
        <meta charset="UTF-8">
        <meta name="description" content="WUPHF.com - The place to bark your thoughts">
        <meta name="keywords" content="wuphf, woof">
        <meta name="author" content="Mauro Farina">
        <meta name="viewport" content="width=device-width, initial-scale=1">

		<!-- Vue.js -->
		<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

		<!-- Bootstrap 5-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
        <!-- Bootstrap icons-->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
        <!-- Bootstrap JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>

        <style>
            :root {
				--primary: #9D4EDD;
			}
			.local-primary-text {
				color: var(--primary) !important;
			}
            .home-main {
                /* https://mor10.com/wceu2017/ */
                display: grid;
                grid-template-columns: 1fr 2fr;
                grid-template-areas: 
                    "nav section";
                height: 100vh;
            }

            .home-nav {
                grid-area: nav;
            }
            
            .home-section {
                grid-area: section;
                padding-left: 12%;
                padding-right: 12%;
                padding-bottom: 50px;
                padding-top: 50px;
            }

            .link-no-underine {
                text-decoration: none;
            }

            .font-m {
                font-size: medium;
            }

            .font-l {
                font-size: large;
            }

            .font-xl {
                font-size: x-large;
            }

            .font-xxl {
                font-size: xx-large;
            }

            .nav-list {
                list-style: none;
            }

            .nav-list li {
                padding-bottom: 20px;
            }

            .nav-list:nth-child(1) {
                padding-top: 10px;
            }

            .btn {
                color: #9D4EDD;
            }

            .message {
                border-width: 1px 0px 0px 0px;
                border-color: var( --bs-border-color);
                border-style: solid;
                padding-top: 15px;
                padding-right: 15px;
                padding-left: 15px;
                padding-bottom: 0px;
            }

            #newMessageTextArea {
                resize: none;
                background-color: aliceblue;
                color : var(--bs-dark) !important;
            }

            input {
				color : var(--bs-dark) !important;
			}

            .nav-icon {
                width: 100px;
            }

            /* TMP BORDERS 
            article {
                box-sizing: border-box;
                outline: 2px solid pink !important; 
            }

            section {
                box-sizing: border-box;
                outline: 1px solid red !important; 
            }

            */

            @media screen and (max-width: 991.5px) {
                .home-main {
                    grid-template-columns: 1fr;
                    grid-template-rows: 70px 1fr;
                    grid-template-areas:
                        "nav"
                        "section";
                }

                .home-nav {
                    height: 70px;
                    background-color: var(--bs-dark);
                }

                .home-section {
                    padding-top: 10px;
                    padding-bottom: 10px;
                    padding-left: 2%;
                    padding-right: 2%;
                }

                #navbarSupportedContent {
                    background-color: var(--bs-dark);
                }

                #buttonTogglerContainer {
                    background-color: var(--bs-dark);
                }

                /*
                #navbarSupportedContent {
                    height: 100vh;
                }
                */

            }

            @media screen and (min-width: 991.5px) {
                nav div.container-fluid {
                    position: fixed;
                    top: 20px;
                    left: -10px;
                    max-width: fit-content;
                }

                .home-section {
                    border-width: 0px 0px 0px 1px;
                    border-style: solid;
                    border-color: var(--bs-light);
                }
            }

            @media screen and (min-width: 1200px) {
                nav div.container-fluid {
                    position: fixed;
                    top: 20px;
                    left: 25px;
                    max-width: fit-content;
                }
            }

            /* https://stackoverflow.com/a/42262375 */
            [v-cloak] {
                display: none;
            }

        </style>
    </head>
    
    <body data-bs-theme="dark"> <!-- DARK -->
        
          <main id="app" class="home-main text-bg-dark">

            <nav class="home-nav navbar navbar-expand-lg collapse-lg fixed-top">
                <div class="container-fluid">
                <!--<div class="container-fluid row flex-lg-column flex-md-row">-->

                    <div class="container-fluid" id="buttonTogglerContainer">
                    <!--<div class="container-fluid col" id="buttonTogglerContainer">-->
                        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                            <span class="navbar-toggler-icon"></span>
                        </button>
                    </div>

                    <!-- navbar-brand -->
                    <!--
                    <div class="container col" id="nav-icon-container"> 
                        <a class="navbar-brand" href="/home">
                            <img src="./favicon.ico" class="nav-icon">
                        </a>
                    </div>
                    -->
                    
                    <!--<div class="container-fluid collapse navbar-collapse col" id="navbarSupportedContent">-->
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <!--<ul class="nav-list navbar-nav me-auto mt-2" style="flex-direction:column">-->
                        <ul class="nav-list me-auto mt-2 font-xl" style="flex-direction:column">
                            <li class="nav-item" v-cloak>
                                <span class="nav-link font-xxl" v-if="user.authenticated">Hi, <a :href="'/api/social/users/'.concat(user.username)" class="local-primary-text link-no-underine">{{user.username}}</a></span>
                                <span class="nav-link" v-if="!user.authenticated">
                                    <a href="/" class="link-no-underine">Signup</a> or <a href="/login" class="link-no-underine">Login</a>
                                </span>
                            </li>
                            <li class="nav-item">
                                <a href="/home" class="nav-link">Feed</a>
                            </li>
                            <li class="nav-item">
                                <a href="#top" class="nav-link">New message</a>
                            </li>
                            <div class="input-group nav-item" v-cloak>
                                <input class="form-control" v-model="usernameToLookup" @input.prevent="searchUser" placeholder="Search user" type="search" aria-label="Search">
                                <!--<button class="btn btn-success" @click.prevent="searchUser" type="submit" id="searchUserButton"><i class="bi bi-search"></i></button>-->
                            </div>

                        </ul>
                    </div>

                </div>
            </nav>

            <div id="top"></div>

            <section class="home-section row row-cols-1 text-start font-l">

                <article class="col" id="newMessage" v-if="user.authenticated && showFeed" v-cloak>
                    <form>
                        <div class="mb-3">
                            <!--<label for="newMessageTextArea" class="form-label">What's barking through your mind?</label>-->
                            <textarea class="form-control" id="newMessageTextArea" rows="3" placeholder="What's barking through your mind?"></textarea>
                        </div>
                        <button id="woofNewMessageButton" class="btn btn-dark" type="submit" @click.prevent="postNewMessage">Woof it!</button>
                    </form>
                </article>

                <div v-for="msg in messages" v-cloak class="container-fluid col message-container" v-if="user.authenticated && showFeed">
                    <!--<article class="col message" :id="(msg.messageID).concat('-').concat(msg.username)">-->
                    <article class="message" :id="(msg.username).concat('#').concat(msg.messageID)">
                        <div class="container-fluid">
                            <!--<button class="btn" :data-username-toggle-follow="msg.username" :data-username-logged="user.username" onclick="toggleFollow(this)" type="submit">-->
                            <button class="btn" @click.prevent="toggleFollow(msg.username)" v-if="msg.username !== user.username" type="submit">
                                <i class="bi bi-person-check-fill" :data-follow-icon-for="msg.username"></i>
                            </button>
                            <span><a :href="'/api/social/users/'.concat(msg.username)">@{{msg.username}}</a> {{convertDate(msg.date)}}</span> 
                            <p>
                                {{msg.message}}
                            </p>
                        </div>
                    </article>
                </div>

                <article v-if="!user.authenticated" class="col" v-cloak>
                    Create an account to start following users and personalize your feed!
                </article>

                <div v-for="foundUser in searchUserResults" class="container-fluid col" v-cloak v-if="showSearch">
                    <article class="message">
                        <div class="container-fluid">
                            <span v-if="foundUser.username === user.username" class="text-muted pe-2">(you)</span>
                            <button class="btn" @click.prevent="toggleFollow(foundUser.username)" type="submit" v-if="user.authenticated && foundUser.username !== user.username">
                                <i v-if="user.followedUsers.includes(foundUser.username)" class="bi bi-person-check-fill" :data-follow-icon-for="foundUser.username"></i>
                                <i v-if="!user.followedUsers.includes(foundUser.username)" class="bi bi-person-fill-add" :data-follow-icon-for="foundUser.username"></i>
                            </button>
                            <span><a :href="'/api/social/users/'.concat(foundUser.username)">@{{foundUser.username}}</a> - {{foundUser.firstName}} {{foundUser.lastName}}</span> 
                            <p>
                                {{foundUser.bio}}
                            </p>
                        </div>
                    </article>
                </div>

            </section>

        </main>

        <script>
            async function getUserData() {
                const fetchOptions = {
                    redirect: 'follow'
                };
                let whoamiResponse = await fetch("/api/social/whoami", fetchOptions);
                if (!whoamiResponse.ok) {
                    throw new Error(`HTTP error: ${whoamiResponse.status}`);
                }
                const user = await whoamiResponse.json();

                let feedResponse = await fetch('/api/social/feed', fetchOptions);
                if (!feedResponse.ok) {
                    throw new Error(`HTTP error: ${feedResponse.status}`);
                }
                const feed = await feedResponse.json();
                return {
                    user : user,
                    feed : feed
                };
            }

            async function createVueApp() {
                const { createApp } = Vue;
                const userData = await getUserData();

                const data = { 
                    messages : userData.feed, 
                    user : userData.user,
                    usernameToLookup : "",
                    searchUserResults : []
                };

                const app = createApp({
                    data() {
                        return data;
                    },
                    methods: {
                        convertDate(date) {
                            const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
                            const dateSplit = date.split('T');
                            const dateYYYYMMDD = dateSplit[0].split('-'); 
                            // 2023-01-07 -> January 7, 2023
                            const datemmDDYYYY = months[parseInt(dateYYYYMMDD[1])-1] 
                                                    + " " + dateYYYYMMDD[2]
                                                    + ", " + dateYYYYMMDD[0];
                            const dateTime = dateSplit[1].split('.')[0].substring(0,5);
                            return dateTime + " GMT " + datemmDDYYYY;
                        },
                        async postNewMessage() {

                            // on send new woof -> show new feed (or just push new msg on top...)

                            const newMessageTextarea = document.getElementById('newMessageTextArea');
                            const newWoof = newMessageTextarea.value;

                            // check length != 0

                            let postNewWoof = await fetch('/api/social/messages', {
                                method: 'POST',
                                redirect: 'follow',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    "message" : newWoof
                                })
                            }).catch(err => console.err(err));
                            
                            // erase textarea
                            newMessageTextarea.value = "";
                            
                            // add new message to the feed without reloading!
                            await fetch(`/api/social/messages/${this.user.username}`)
                                .then(res => res.json()).then(msgs => this.messages.splice(0,0,msgs[0])).catch(err => console.error(err));
                        },
                        async toggleFollow(usernameToggleFollow) {
                            const usernameLogged = this.user.username;
                            let getFollowers = await fetch(`/api/social/followers/${usernameToggleFollow}`);
                            if(!getFollowers.ok) {
                                console.err("ooooh upsie");
                                return;
                            }
                            let followersJson = await getFollowers.json();
                            const httpMethod = followersJson.followers.includes(usernameLogged) ? 'DELETE' : 'POST';
                            let toggleFollowFetch = await fetch(`/api/social/followers/${usernameToggleFollow}`, {
                                method: httpMethod
                            });
                            if(!toggleFollowFetch.ok) {
                                console.err("well thats unexpected");
                                return; //error D:
                            }
                            document.querySelectorAll(`[data-follow-icon-for="${usernameToggleFollow}"]`)
                                .forEach(el => {
                                    el.classList.toggle('bi-person-check-fill');
                                    el.classList.toggle('bi-person-fill-add');
                                });
                        },
                        async searchUser() {
                            let queryResults = await fetch(`/api/social/search?q=${this.usernameToLookup}`).then(res => res.json()).catch(err => console.err(err));
                            if(queryResults.length === undefined) { return; }
                            this.searchUserResults = queryResults;
                            if(window.visualViewport.width < 991.5) {
                                console.log(`${window.visualViewport.width} < 972`);
                                document.getElementById('buttonTogglerContainer').firstElementChild.click();
                            }
                            //queryResults.forEach(e => console.log(e.username));
                        }
                    },
                    computed: {
                        showFeed() {
                            return this.usernameToLookup.trim().length > 0 ? false : true;
                        },
                        showSearch() {
                            return this.usernameToLookup.trim().length > 0 ? true : false;
                        }
                    }
                });
                app.mount("#app");
            }
        </script>

        <script>
            createVueApp();
        </script>

    </body>

</html>