<!DOCTYPE html>
<html>
    <head>
        <title>WUPHF.com</title>
        <meta charset="UTF-8">
        <meta name="description" content="WUPHF.com - The place to bark your thoughts">
        <meta name="keywords" content="wuphf, woof">
        <meta name="author" content="Mauro Farina">
        <meta name="viewport" content="width=device-width, initial-scale=1">

		<!-- Vue.js -->
		<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

		<!-- Bootstrap 5-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
        <!-- Bootstrap icons-->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
        <!-- Bootstrap JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>

        <style>
            .home-main {
                /* https://mor10.com/wceu2017/ */
                display: grid;
                grid-template-columns: 1fr 2fr;
                grid-template-areas: 
                    "nav section";
                height: 100vh;
            }

            .home-nav {
                grid-area: nav;
            }
            
            .home-section {
                grid-area: section;
                padding-left: 12%;
                padding-right: 12%;
                padding-bottom: 50px;
                padding-top: 50px;
            }

            .font-m {
                font-size: medium;
            }

            .font-l {
                font-size: large;
            }

            .font-xl {
                font-size: x-large;
            }

            .nav-list {
                list-style: none;
            }

            .nav-list li {
                padding-bottom: 20px;
            }

            .nav-list:nth-child(1) {
                padding-top: 10px;
            }

            .btn {
                color: #9D4EDD;
            }

            .message {
                border-width: 1px 0px 0px 0px;
                border-color: var( --bs-border-color);
                border-style: solid;
                padding-top: 15px;
                padding-right: 15px;
                padding-left: 15px;
                padding-bottom: 0px;
            }

            #newMessageTextArea {
                resize: none;
                background-color: aliceblue;
                color : var(--bs-dark) !important;
            }

            input {
				color : var(--bs-dark) !important;
			}

            .nav-icon {
                width: 100px;
            }

            /* TMP BORDERS 
            article {
                box-sizing: border-box;
                outline: 2px solid pink !important; 
            }

            section {
                box-sizing: border-box;
                outline: 1px solid red !important; 
            }

            */

            @media screen and (max-width: 991.5px) {
                .home-main {
                    grid-template-columns: 1fr;
                    grid-template-rows: 70px 1fr;
                    grid-template-areas:
                        "nav"
                        "section";
                }

                .home-nav {
                    height: 70px;
                    background-color: var(--bs-dark);
                }

                .home-section {
                    padding-top: 10px;
                    padding-bottom: 10px;
                    padding-left: 2%;
                    padding-right: 2%;
                }

                #navbarSupportedContent {
                    background-color: var(--bs-dark);
                }

                #buttonTogglerContainer {
                    background-color: var(--bs-dark);
                }

                /*
                #navbarSupportedContent {
                    height: 100vh;
                }
                */

            }

            @media screen and (min-width: 991.5px) {
                nav div.container-fluid {
                    position: fixed;
                    top: 20px;
                    left: -10px;
                    max-width: fit-content;
                }

                .home-section {
                    border-width: 0px 0px 0px 1px;
                    border-style: solid;
                    border-color: var(--bs-light);
                }
            }

            @media screen and (min-width: 1200px) {
                nav div.container-fluid {
                    position: fixed;
                    top: 20px;
                    left: 25px;
                    max-width: fit-content;
                }
            }

            /* https://stackoverflow.com/a/42262375 */
            [v-cloak] {
                display: none;
            }

        </style>
    </head>
    
    <body data-bs-theme="dark"> <!-- DARK -->
        
          <main id="app" class="home-main text-bg-dark">

            <nav class="home-nav navbar navbar-expand-lg font-xl collapse-lg fixed-top">
                <div class="container-fluid">
                <!--<div class="container-fluid row flex-lg-column flex-md-row">-->

                    <div class="container-fluid" id="buttonTogglerContainer">
                    <!--<div class="container-fluid col" id="buttonTogglerContainer">-->
                        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                            <span class="navbar-toggler-icon"></span>
                        </button>
                    </div>

                    <!-- navbar-brand -->
                    <!--
                    <div class="container col" id="nav-icon-container"> 
                        <a class="navbar-brand" href="/home">
                            <img src="./favicon.ico" class="nav-icon">
                        </a>
                    </div>
                    -->
                    
                    <!--<div class="container-fluid collapse navbar-collapse col" id="navbarSupportedContent">-->
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <!--<ul class="nav-list navbar-nav me-auto mt-2" style="flex-direction:column">-->
                            <ul class="nav-list me-auto mt-2" style="flex-direction:column">
                            <li class="nav-item">
                                <a class="nav-link" v-cloak>Hi, {{user.username}}</a>
                            </li>
                            <li class="nav-item">
                                <a :href="'/api/social/users/'.concat(user.username)" class="nav-link">Profile</a>
                            </li>
                            <li class="nav-item">
                                <a href="#newMessage" class="nav-link">New message</a>
                            </li>
                            <div class="input-group nav-item">
                                <input class="form-control" type="search" placeholder="Search user" aria-label="Search">
                                <button class="btn btn-success" type="submit" id="searchUserButton"><i class="bi bi-search"></i></button>
                            </div>

                        </ul>
                    </div>

                </div>
            </nav>

            <section class="home-section row row-cols-1 text-start font-l">

                <article class="col" id="newMessage">
                    <form>
                        <div class="mb-3">
                            <!--<label for="newMessageTextArea" class="form-label">What's barking through your mind?</label>-->
                            <textarea class="form-control" id="newMessageTextArea" rows="3" placeholder="What's barking through your mind?"></textarea>
                        </div>
                        <button id="woofNewMessageButton" class="btn btn-dark" type="submit" @click.prevent="postNewMessage">Woof it!</button>
                    </form>
                </article>

                <div v-for="msg in messages" v-cloak class="container-fluid">
                    <!--<article class="col message" :id="(msg.messageID).concat('-').concat(msg.username)">-->
                    <article class="col message" :id="(msg.username).concat('#').concat(msg.messageID)">
                        <div class="container-fluid">
                            <!--<button class="btn" :data-username-toggle-follow="msg.username" :data-username-logged="user.username" onclick="toggleFollow(this)" type="submit">-->
                            <button class="btn" @click.prevent="toggleFollow(msg.username)" type="submit">
                                <i class="bi bi-person-check-fill" :data-follow-icon-for="msg.username"></i>
                            </button>
                            <span><a :href="'/api/social/users/'.concat(msg.username)">@{{msg.username}}</a> {{convertDate(msg.date)}}</span> 
                            <p>
                                {{msg.message}}
                            </p>
                        </div>
                    </article>
                </div>

            </section>

        </main>

        <script>
            async function getUserData() {
                try {
                    const fetchOptions = {
                        redirect: 'follow'
                    };

                    let whoamiResponse = await fetch("/api/social/whoami", fetchOptions);
                    if (!whoamiResponse.ok) {
                        throw new Error(`HTTP error: ${whoamiResponse.status}`);
                    }
                    if(whoamiResponse.redirected) {
                        window.location.href = whoamiResponse.url;
                    }
                    const userData = await whoamiResponse.json();

                    let feedResponse = await fetch('/api/social/feed', fetchOptions);
                    if (!feedResponse.ok) {
                        throw new Error(`HTTP error: ${feedResponse.status}`);
                    }
                    if(feedResponse.redirected) {
                        window.location.href = feedResponse.url;
                    }
                    const feedData = await feedResponse.json();
                    
                    const { createApp } = Vue;
                    const data = { 
                        messages : feedData, 
                        user : userData
                    };

                    const app = createApp({
                        data() {
                            return data;
                        },
                        methods: {
                            convertDate(date) {
                                const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
                                const dateSplit = date.split('T');
                                const dateYYYYMMDD = dateSplit[0].split('-'); 
                                // 2023-01-07 -> January 7, 2023
                                const datemmDDYYYY = months[parseInt(dateYYYYMMDD[1])-1] 
                                                        + " " + dateYYYYMMDD[2]
                                                        + ", " + dateYYYYMMDD[0];
                                const dateTime = dateSplit[1].split('.')[0].substring(0,5);
                                return dateTime + " GMT " + datemmDDYYYY;
                            },
                            async postNewMessage() {
                                const newWoof = document.getElementById('newMessageTextArea').value;
                                let postNewWoof = await fetch('/api/social/messages', {
                                    method: 'POST',
                                    redirect: 'follow',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        "message" : newWoof
                                    })
                                }).then(res => alert('posted ' + newWoof)).catch(err => alert(err));
                            },
                            async toggleFollow(usernameToggleFollow) {
                                const usernameLogged = this.user.username;
    
                                let getFollowers = await fetch(`/api/social/followers/${usernameToggleFollow}`);

                                if(!getFollowers.ok) {
                                    console.err("ooooh upsie");
                                    return;
                                }
                                let followersJson = await getFollowers.json();
                                const httpMethod = followersJson.followers.includes(usernameLogged) ? 'DELETE' : 'POST';
                                let toggleFollowFetch = await fetch(`/api/social/followers/${usernameToggleFollow}`, {
                                    method: httpMethod
                                });
                                if(!toggleFollowFetch.ok) {
                                    console.err("well thats unexpected");
                                    return; //error D:
                                }
                                document.querySelectorAll(`[data-follow-icon-for="${usernameToggleFollow}"]`)
                                    .forEach(el => {
                                        el.classList.toggle('bi-person-check-fill');
                                        el.classList.toggle('bi-person-fill-add');
                                    });
                            }
                        }
                    });
                    app.mount("#app");
                } catch(error) {
                    console.error(`Could not get data: ${error}`);
                }
            }
            getUserData();
        </script>

    </body>

</html>