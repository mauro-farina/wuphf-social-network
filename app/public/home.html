<!DOCTYPE html>
<html>
    <head>
        <title>WUPHF.com</title>
        <meta charset="UTF-8">
        <meta name="description" content="WUPHF.com - The place to bark your thoughts">
        <meta name="keywords" content="wuphf, woof">
        <meta name="author" content="Mauro Farina">
        <meta name="viewport" content="width=device-width, initial-scale=1">

		<!-- Vue.js -->
		<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

		<!-- Bootstrap 5-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
        <!-- Bootstrap icons-->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
        <!-- Bootstrap JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>

        <link rel="stylesheet" href="./res/style.css">
    </head>
    
    <body data-bs-theme="dark"> <!-- DARK -->
        
          <main id="app" class="home-main text-bg-dark">

            <nav class="home-nav navbar navbar-expand-lg collapse-lg fixed-top">
                <div class="container-fluid">
                <!--<div class="container-fluid row flex-lg-column flex-md-row">-->

                    <div class="container-fluid" id="buttonTogglerContainer">
                    <!--<div class="container-fluid col" id="buttonTogglerContainer">-->
                        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                            <span class="navbar-toggler-icon"></span>
                        </button>
                    </div>

                    <!-- navbar-brand -->
                    <!--
                    <div class="container col" id="nav-icon-container"> 
                        <a class="navbar-brand" href="/home">
                            <img src="./favicon.ico" class="nav-icon">
                        </a>
                    </div>
                    -->
                    
                    <!--<div class="container-fluid collapse navbar-collapse col" id="navbarSupportedContent">-->
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <!--<ul class="nav-list navbar-nav me-auto mt-2" style="flex-direction:column">-->
                        <ul class="nav-list me-auto mt-2 font-xl" style="flex-direction:column">
                            <li class="nav-item" v-cloak>
                                <span class="nav-link font-xxl" v-if="user.authenticated">Hi, <a :href="'/api/social/users/'.concat(user.username)" class="local-primary-text link-no-underine">{{user.username}}</a></span>
                                <span class="nav-link" v-if="!user.authenticated">
                                    <a href="/" class="link-no-underine">Signup</a> or <a href="/login" class="link-no-underine">Login</a>
                                </span>
                            </li>
                            <li class="nav-item">
                                <a href="/home" class="nav-link">Feed</a>
                            </li>
                            <li class="nav-item">
                                <a href="#top" class="nav-link">New message</a>
                            </li>
                            <div class="input-group nav-item" v-cloak>
                                <input id="searchUserInput" class="form-control" v-model="usernameToLookup" @input.prevent="searchUser" placeholder="Search user" type="search" aria-label="Search">
                                <!--<button class="btn btn-success" @click.prevent="searchUser" type="submit" id="searchUserButton"><i class="bi bi-search"></i></button>-->
                            </div>

                        </ul>
                    </div>

                </div>
            </nav>

            <div id="top"></div>

            <section class="home-section row row-cols-1 text-start font-l">

                <article class="col" id="newMessage" v-if="user.authenticated && showFeed" v-cloak>
                    <form>
                        <div class="mb-3">
                            <!--<label for="newMessageTextArea" class="form-label">What's barking through your mind?</label>-->
                            <textarea class="form-control" id="newMessageTextArea" rows="3" placeholder="What's barking through your mind?"></textarea>
                        </div>
                        <button id="woofNewMessageButton" class="btn btn-dark" type="submit" @click.prevent="postNewMessage">Woof it!</button>
                    </form>
                </article>

                <div v-for="msg in messages" v-cloak class="container-fluid col message-container" v-if="user.authenticated && showFeed">
                    <!--<article class="col message" :id="(msg.messageID).concat('-').concat(msg.username)">-->
                    <article class="message" :id="(msg.username).concat('#').concat(msg.messageID)">
                        <div class="container-fluid">
                            <!--<button class="btn" :data-username-toggle-follow="msg.username" :data-username-logged="user.username" onclick="toggleFollow(this)" type="submit">-->
                            <button class="btn" @click.prevent="toggleFollow(msg.username)" v-if="msg.username !== user.username" type="submit">
                                <i class="bi bi-person-check-fill" :data-follow-icon-for="msg.username"></i>
                            </button>
                            <span><a :href="'/api/social/users/'.concat(msg.username)">@{{msg.username}}</a> {{convertDate(msg.date)}}</span> 
                            <p>
                                {{msg.message}}
                            </p>
                            <button class="btn" @click.prevent="toggleLike(msg.messageID)" type="submit">
                                <i v-if="user.likedMessages.includes(msg.messageID)" class="bi bi-heart-fill" :data-like-icon-for="msg.messageID"></i>
                                <i v-if="!user.likedMessages.includes(msg.messageID)" class="bi bi-heart" :data-like-icon-for="msg.messageID"></i>
                            </button>
                        </div>
                    </article>
                </div>

                <article v-if="!user.authenticated" class="col" v-cloak>
                    Create an account to start following users and personalize your feed!
                </article>

                <div v-for="foundUser in searchUserResults" class="container-fluid col" v-cloak v-if="showSearch">
                    <article class="message">
                        <div class="container-fluid">
                            <span v-if="foundUser.username === user.username" class="text-muted pe-2">(you)</span>
                            <button class="btn" @click.prevent="toggleFollow(foundUser.username)" type="submit" v-if="user.authenticated && foundUser.username !== user.username">
                                <i v-if="user.followedUsers.includes(foundUser.username)" class="bi bi-person-check-fill" :data-follow-icon-for="foundUser.username"></i>
                                <i v-if="!user.followedUsers.includes(foundUser.username)" class="bi bi-person-fill-add" :data-follow-icon-for="foundUser.username"></i>
                            </button>
                            <span><a :href="'/api/social/users/'.concat(foundUser.username)">@{{foundUser.username}}</a> - {{foundUser.firstName}} {{foundUser.lastName}}</span> 
                            <p>
                                {{foundUser.bio}}
                            </p>
                        </div>
                    </article>
                </div>

            </section>

        </main>

        <script>
            async function getUserData() {
                const fetchOptions = {
                    redirect: 'follow'
                };
                let whoamiResponse = await fetch("/api/social/whoami", fetchOptions);
                if (!whoamiResponse.ok) {
                    throw new Error(`HTTP error: ${whoamiResponse.status}`);
                }
                const user = await whoamiResponse.json();

                let feedResponse = await fetch('/api/social/feed', fetchOptions);
                if (!feedResponse.ok) {
                    throw new Error(`HTTP error: ${feedResponse.status}`);
                }
                const feed = await feedResponse.json();
                return {
                    user : user,
                    feed : feed
                };
            }

            async function createVueApp() {
                const { createApp } = Vue;
                const userData = await getUserData();

                const data = { 
                    messages : userData.feed, 
                    user : userData.user,
                    usernameToLookup : "",
                    searchUserResults : []
                };

                const app = createApp({
                    data() {
                        return data;
                    },
                    methods: {
                        convertDate(date) {
                            const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
                            const dateSplit = date.split('T');
                            const dateYYYYMMDD = dateSplit[0].split('-'); 
                            // 2023-01-07 -> January 7, 2023
                            const datemmDDYYYY = months[parseInt(dateYYYYMMDD[1])-1] 
                                                    + " " + dateYYYYMMDD[2]
                                                    + ", " + dateYYYYMMDD[0];
                            const dateTime = dateSplit[1].split('.')[0].substring(0,5);
                            return dateTime + " GMT " + datemmDDYYYY;
                        },
                        async postNewMessage() {

                            // on send new woof -> show new feed (or just push new msg on top...)

                            const newMessageTextarea = document.getElementById('newMessageTextArea');
                            const newWoof = newMessageTextarea.value;

                            // check length != 0

                            let postNewWoof = await fetch('/api/social/messages', {
                                method: 'POST',
                                redirect: 'follow',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    "message" : newWoof
                                })
                            }).catch(err => console.err(err));

                            // erase textarea
                            newMessageTextarea.value = "";
                            
                            // add new message to the feed without reloading!
                            await fetch(`/api/social/messages/${this.user.username}`)
                                .then(res => res.json()).then(msgs => this.messages.unshift(msgs[0])).catch(err => console.error(err));
                        },
                        async toggleFollow(usernameToggleFollow) {
                            const usernameLogged = this.user.username;
                            const followIconElement = document.querySelector(`[data-follow-icon-for="${usernameToggleFollow}"]`);
                            const httpMethod = followIconElement.classList.contains("bi-person-fill-add") ? 'POST' : 'DELETE';
                            let toggleFollowFetch = await fetch(`/api/social/followers/${usernameToggleFollow}`, { method: httpMethod });
                            document.querySelectorAll(`[data-follow-icon-for="${usernameToggleFollow}"]`)
                                .forEach(el => {
                                    el.classList.toggle('bi-person-check-fill');
                                    el.classList.toggle('bi-person-fill-add');
                                });
                        },
                        async toggleLike(messageID) {
                            const usernameLogged = this.user.username;
                            const likeIconElement = document.querySelector(`[data-like-icon-for="${messageID}"]`);
                            const httpMethod = likeIconElement.classList.contains("bi-heart") ? 'POST' : 'DELETE';
                            await fetch(`/api/social/like/${messageID}`, { method: httpMethod });
                            likeIconElement.classList.toggle("bi-heart-fill");
                            likeIconElement.classList.toggle("bi-heart");
                        },
                        async searchUser() {
                            let queryResults = await fetch(`/api/social/search?q=${this.usernameToLookup}`).then(res => res.json()).catch(err => console.err(err));
                            if(queryResults.length === undefined) { return; }
                            this.searchUserResults = queryResults;
                            //window.location.hash = `search?q=${this.usernameToLookup}`;
                            //console.log('/home'.concat(window.location.hash)); // [ /home#search?q=query

                            /*
                                / -> signup & index page
                                /login -> login page
                                /app#home -> feed
                                /app#search?q=... -> search users
                                /app#user?u=... -> profile of user
                            */

                            if(window.visualViewport.width < 991.5) {
                                console.log(`${window.visualViewport.width} < 972`);
                                document.getElementById('buttonTogglerContainer').firstElementChild.click();
                            }
                            //queryResults.forEach(e => console.log(e.username));
                        }
                    },
                    computed: {
                        showFeed() {
                            return this.usernameToLookup.trim().length > 0 ? false : true;
                        },
                        showSearch() {
                            return this.usernameToLookup.trim().length > 0 ? true : false;
                        }
                    }
                });
                app.mount("#app");
            }
        </script>

        <script>
            createVueApp();
        </script>

    </body>

</html>